<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>json2go web parser</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <style>
        @media (min-width: 1200px) {
            .container, .container-lg, .container-md, .container-sm, .container-xl {
                max-width: 1600px;
            }
        }
    </style>

    <link href="jsoneditor/jsoneditor.min.css" rel="stylesheet" type="text/css">
    <script defer src="jsoneditor/jsoneditor.min.js"></script>

    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">

    <style>
        .help-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            line-height: 14px;
            text-align: center;
            border-radius: 50%;
            background-color: #6c757d;
            color: white;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
            cursor: help;
        }
        .help-icon:hover {
            background-color: #5a6268;
        }
    </style>
</head>

<body class="bg-light container px-5">
    <div class="py-3 mb-4">
        <div class="row justify-content-center">
            <div class="col-md-auto align-self-center">
                <img class="mx-4" src="gopher.svg" alt="" height="128">
            </div>

            <div class="col-md-auto">
                <h1 class="display-3">json2go web parser</h1>
                <p class="lead">
                    Paste json to generate go struct.<br/>
                    For source code and more details see <a href="https://github.com/m-zajac/json2go">https://github.com/m-zajac/json2go</a><br/>
                    If you use Visual Studio Code, checkout this cool <a href="https://marketplace.visualstudio.com/items?itemName=m-zajac.vsc-json2go" target="blank">vsc-json2go</a> extension!
                </p>
            </div>
        </div>
    </div>

    <form>
        <div class="form-group row">
            <label for="url" class="col-2 col-form-label">Load JSON from URL</label>
            <div class="col-10">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <div class="input-group-text">
                            <em class="fa fa-address-card">URL</em>
                        </div>
                    </div>
                    <input id="url" type="text" class="form-control">
                    <button type="button" class="btn btn-primary" id="loadurl">Load</button>
                </div>
            </div>
        </div>
        
        <hr/>
        
        <div class="form-group row">
            <label class="col-2 col-form-label">Options</label>
            <div class="col-10">
                <div class="form-group row mb-2">
                    <label for="rootName" class="col-5 col-form-label col-form-label-sm">
                        Root name
                        <span class="help-icon" title="The name of the root/top-level Go struct that will be generated">?</span>
                    </label>
                    <div class="col-7">
                        <input id="rootName" class="form-control form-control-sm json2go" type="text" value="Document"/>
                    </div>
                </div>

                <div class="form-group row mb-2">
                    <label for="stringPointersWhenKeyMissing" class="col-5 col-form-label col-form-label-sm">
                        String pointers when key missing
                        <span class="help-icon" title="When a key is missing in some objects, use *string instead of string to distinguish between empty and missing values">?</span>
                    </label>
                    <div class="col-7">
                        <div class="form-check mt-2">
                            <input id="stringPointersWhenKeyMissing" type="checkbox" class="json2go form-check-input" checked="checked">
                            <label for="stringPointersWhenKeyMissing" class="form-check-label">
                                <small class="text-muted">Use *string when key is missing</small>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group row mb-2">
                    <label for="skipEmptyKeys" class="col-5 col-form-label col-form-label-sm">
                        Skip empty keys
                        <span class="help-icon" title="Omit struct fields for keys that only have null values in all JSON samples">?</span>
                    </label>
                    <div class="col-7">
                        <div class="form-check mt-2">
                            <input id="skipEmptyKeys" type="checkbox" class="json2go form-check-input" checked="checked">
                            <label for="skipEmptyKeys" class="form-check-label">
                                <small class="text-muted">Skip keys with only null values</small>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group row mb-2">
                    <label for="useMaps" class="col-5 col-form-label col-form-label-sm">
                        Use maps
                        <span class="help-icon" title="Detect objects with many similar keys and represent them as map[string]T instead of structs">?</span>
                    </label>
                    <div class="col-7">
                        <div class="form-check mt-2">
                            <input id="useMaps" type="checkbox" class="json2go form-check-input" checked="checked">
                            <label for="useMaps" class="form-check-label">
                                <small class="text-muted">Try to use maps for objects</small>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group row mb-2">
                    <label for="useMapsMinAttrs" class="col-5 col-form-label col-form-label-sm">
                        Min attributes for maps
                        <span class="help-icon" title="Minimum number of attributes an object must have before considering it for map representation">?</span>
                    </label>
                    <div class="col-7">
                        <input id="useMapsMinAttrs" class="form-control form-control-sm json2go" type="number" 
                               min="1" step="1" value="5">
                    </div>
                </div>

                <div class="form-group row mb-2">
                    <label for="timeAsStr" class="col-5 col-form-label col-form-label-sm">
                        Time as string
                        <span class="help-icon" title="Keep time values as strings instead of converting them to time.Time type">?</span>
                    </label>
                    <div class="col-7">
                        <div class="form-check mt-2">
                            <input id="timeAsStr" type="checkbox" class="json2go form-check-input">
                            <label for="timeAsStr" class="form-check-label">
                                <small class="text-muted">Don't use time.Time, just strings</small>
                            </label>
                        </div>
                    </div>
                </div>

                <hr class="my-3"/>
                <div class="mb-2">
                    <h6 class="text-muted mb-0">Type Extraction</h6>
                    <small class="text-muted">Options for extracting and reusing common types</small>
                </div>

                <div class="form-group row mb-2">
                    <label for="extractCommonTypes" class="col-5 col-form-label col-form-label-sm">
                        Extract common types
                        <span class="help-icon" title="Analyze objects to find and extract common patterns into reusable struct types, reducing code duplication">?</span>
                    </label>
                    <div class="col-7">
                        <div class="form-check mt-2">
                            <input id="extractCommonTypes" type="checkbox" checked="checked" class="json2go form-check-input">
                            <label for="extractCommonTypes" class="form-check-label">
                                <small class="text-muted">Extract and reuse common struct types</small>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group row mb-2">
                    <label for="similarityThreshold" class="col-5 col-form-label col-form-label-sm">
                        Similarity threshold
                        <span class="help-icon" title="How similar two structs must be (0.0-1.0) to be merged into the same type. Higher values require more similarity">?</span>
                    </label>
                    <div class="col-7">
                        <input id="similarityThreshold" class="form-control form-control-sm json2go" type="number" 
                               min="0" max="1" step="0.1" value="0.7">
                    </div>
                </div>

                <div class="form-group row mb-2">
                    <label for="minSubsetSize" class="col-5 col-form-label col-form-label-sm">
                        Min subset size
                        <span class="help-icon" title="Minimum number of shared fields required to consider extracting them as a common embedded type">?</span>
                    </label>
                    <div class="col-7">
                        <input id="minSubsetSize" class="form-control form-control-sm json2go" type="number" 
                               min="1" step="1" value="2">
                    </div>
                </div>

                <div class="form-group row mb-2">
                    <label for="minSubsetOccurrences" class="col-5 col-form-label col-form-label-sm">
                        Min subset occurrences
                        <span class="help-icon" title="How many times a pattern of shared fields must appear before extracting it as a separate type">?</span>
                    </label>
                    <div class="col-7">
                        <input id="minSubsetOccurrences" class="form-control form-control-sm json2go" type="number" 
                               min="1" step="1" value="2">
                    </div>
                </div>

                <div class="form-group row mb-2">
                    <label for="minAddedFields" class="col-5 col-form-label col-form-label-sm">
                        Min added fields
                        <span class="help-icon" title="Minimum number of unique fields an object must add beyond common fields to justify creating a new type">?</span>
                    </label>
                    <div class="col-7">
                        <input id="minAddedFields" class="form-control form-control-sm json2go" type="number" 
                               min="1" step="1" value="2">
                    </div>
                </div>
            </div>
        </div>

        <hr/>

        <div class="form-group row">
            <label for="editor" class="col-2 col-form-label">JSON input</label>
            <div class="col-10">
                <div id="editor" style="height: 400px;"></div>
            </div>
        </div>

        <hr/>

        <div class="form-group row">
            <label for="output" class="col-2 col-form-label">Output</label>
            <div class="col-10">
                <pre id="output" class="border px-3 py-2" style="background: #FFD">loading...</pre>
            </div>
        </div>
    </form>

    <footer class="text-secondary font-weight-light text-right pb-3">
        Version _VERSION_
        <br/>
        Thanks to <a href="https://github.com/MariaLetta/free-gophers-pack">Maria Letta</a> for awesome gopher image! :)
    </footer>

    <script src="wasm_exec.js"></script>
    <script>
        if (!WebAssembly.instantiateStreaming) { // polyfill
            WebAssembly.instantiateStreaming = async (resp, importObject) => {
                const source = await (await resp).arrayBuffer();
                return await WebAssembly.instantiate(source, importObject);
            };
        }

        const go = new Go();
        let mod, inst;
        WebAssembly.instantiateStreaming(fetch("json2go.wasm"), go.importObject).then((result) => {
            mod = result.module;
            inst = result.instance;
            go.run(inst);
        }).then(() => {
            let onChange = () => { };
            const container = document.getElementById("editor");
            const options = {
                "mode": "code",
                "mainMenuBar": false,
                "onChange": () => {
                    onChange();
                },
            };
            const editor = new JSONEditor(container, options);
            editor.set([
                {
                    "created": "2020-10-03T15:04:05Z",
                    "name": "water",
                    "description": "quite common on earth",
                    "type": "liquid",
                    "boiling_point": {
                        "units": "C",
                        "value": 100
                    },
                    "secret": null,
                    "properties": {
                        "tasteless": true,
                        "odorless": true,
                        "abundant": true,
                        "solid": false
                    }
                },
                {
                    "created": "2020-10-03T15:05:02Z",
                    "name": "oxygen",
                    "type": "gas",
                    "density": {
                        "units": "g/L",
                        "value": 1.429
                    },
                    "properties": {
                        "abundant": true,
                        "odorless": true,
                        "abundant": true,
                        "solid": false
                    }
                },
                {
                    "created": "2020-10-03T17:12:37Z",
                    "name": "carbon monoxide",
                    "type": "gas",
                    "dangerous": true,
                    "boiling_point": {
                        "units": "C",
                        "value": -191.5
                    },
                    "density": {
                        "units": "kg/m3",
                        "value": 789
                    },
                    "secret": null,
                    "properties": {
                        "abundant": true,
                        "flammable": true
                    }
                     
                }
            ]);

            const waitMsg = "waiting for valid json ...";
            const outEl = document.getElementById("output");

            onChange = () => {
                let json = editor.getText();
                let rootName = document.getElementById("rootName").value || "Document";

                let opts = {
                    rootName: rootName,
                    extractCommonTypes: document.getElementById("extractCommonTypes").checked,
                    stringPointersWhenKeyMissing: document.getElementById("stringPointersWhenKeyMissing").checked,
                    skipEmptyKeys: document.getElementById("skipEmptyKeys").checked,
                    useMaps: document.getElementById("useMaps").checked,
                    useMapsMinAttrs: document.getElementById("useMapsMinAttrs").value,
                    timeAsStr: document.getElementById("timeAsStr").checked,
                    similarityThreshold: document.getElementById("similarityThreshold").value,
                    minSubsetSize: document.getElementById("minSubsetSize").value,
                    minSubsetOccurrences: document.getElementById("minSubsetOccurrences").value,
                    minAddedFields: document.getElementById("minAddedFields").value,
                };
                let out = json2go(json, opts);

                if (out) {
                    outEl.innerHTML = out;
                } else {
                    outEl.innerHTML = waitMsg;
                }
            }
            for (let el of document.getElementsByClassName("json2go")) {
                el.addEventListener("change", onChange);
            }
            onChange();

            // load from url
            let loadOk = () => {
                document.getElementById("loadurl").classList.remove("error");
                document.getElementById("loadurl").classList.add("primary");
            }
            let loadErr = () => {
                document.getElementById("loadurl").classList.add("error");
                document.getElementById("loadurl").classList.remove("primary");
            }
            document.getElementById("loadurl").addEventListener("click", () => {
                const url = document.getElementById("url").value;

                fetch(url).then((response) => {
                    response.json().then((json) => {
                        editor.set(json);
                        loadOk();
                        onChange();
                    }).catch((err) => {
                        loadErr();
                        console.error(err);
                    });
                }).catch((err) => {
                    console.error(err);
                    loadErr();
                })
            })
        }).catch((err) => {
            console.error(err);
        });
    </script>
</body>
</html>